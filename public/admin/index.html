<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager - AR Alphaya Jewellery</title>
  </head>
  <body>
    <script>
      // Manual init flag - prevents auto-init before we configure the backend
      window.CMS_MANUAL_INIT = true;
    </script>
    
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <script>
      // Override git-gateway endpoints to use our custom backend
      window.CMS_ENV = 'production';
      window.CMS_MANUAL_INIT = true;
      
      // Initialize CMS with custom backend configuration
      if (window.CMS) {
        window.CMS.registerBackend('git-gateway', {
          init: (config) => {
            return {
              authComponent: () => null, // No auth UI needed, protected by Basic Auth
              authenticate: async () => {
                // Fetch token from our API
                const response = await fetch('/api/admin/auth?provider=github');
                if (!response.ok) throw new Error('Authentication failed');
                const { token } = await response.json();
                return { token, userId: 'admin', userName: 'Admin' };
              },
              logout: () => Promise.resolve(),
              getToken: async () => {
                const response = await fetch('/api/admin/auth?provider=github');
                const { token } = await response.json();
                return token;
              },
              entriesByFolder: async (collection, extension) => {
                const token = await this.getToken();
                const folder = collection.get('folder');
                const response = await fetch(
                  `https://api.github.com/repos/haxllo/ar-alphaya-jewellery/contents/${folder}`,
                  {
                    headers: { 'Authorization': `token ${token}` }
                  }
                );
                const files = await response.json();
                return files.filter(f => f.name.endsWith(`.${extension}`));
              },
              getEntry: async (collection, slug, path) => {
                const token = await this.getToken();
                const response = await fetch(
                  `https://api.github.com/repos/haxllo/ar-alphaya-jewellery/contents/${path}`,
                  {
                    headers: { 'Authorization': `token ${token}` }
                  }
                );
                const file = await response.json();
                const content = atob(file.content);
                return {
                  file: { path },
                  data: content
                };
              },
              persistEntry: async (config, collection, entryDraft, assetProxies) => {
                const token = await this.getToken();
                const path = entryDraft.path;
                const content = entryDraft.raw;
                
                // Get current SHA if file exists
                let sha;
                try {
                  const existing = await fetch(
                    `https://api.github.com/repos/haxllo/ar-alphaya-jewellery/contents/${path}`,
                    {
                      headers: { 'Authorization': `token ${token}` }
                    }
                  );
                  const fileData = await existing.json();
                  sha = fileData.sha;
                } catch (e) {}
                
                // Commit the file
                const response = await fetch(
                  `https://api.github.com/repos/haxllo/ar-alphaya-jewellery/contents/${path}`,
                  {
                    method: 'PUT',
                    headers: {
                      'Authorization': `token ${token}`,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      message: `${sha ? 'Update' : 'Create'} ${collection.get('label')} "${entryDraft.entry.get('title') || slug}"`,
                      content: btoa(content),
                      branch: 'main',
                      ...(sha && { sha })
                    })
                  }
                );
                
                return response.json();
              },
              deleteEntry: async (collection, slug, path) => {
                const token = await this.getToken();
                
                // Get file SHA
                const fileResponse = await fetch(
                  `https://api.github.com/repos/haxllo/ar-alphaya-jewellery/contents/${path}`,
                  {
                    headers: { 'Authorization': `token ${token}` }
                  }
                );
                const { sha } = await fileResponse.json();
                
                // Delete the file
                await fetch(
                  `https://api.github.com/repos/haxllo/ar-alphaya-jewellery/contents/${path}`,
                  {
                    method: 'DELETE',
                    headers: {
                      'Authorization': `token ${token}`,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      message: `Delete ${collection.get('label')} "${slug}"`,
                      sha,
                      branch: 'main'
                    })
                  }
                );
              }
            };
          }
        });
        
        window.CMS.init();
      }
    </script>
  </body>
</html>